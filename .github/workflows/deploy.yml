name: Deploy to SSH Server

on:
  push:
    branches: ["deployment"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Install SSH key
        run: |
          echo -e "$SSH_PRIVATE_KEY" > ssh_key
          chmod 600 ssh_key
          eval $(ssh-agent)
          ssh-add ssh_key
        env:
          SSH_PRIVATE_KEY: "-----BEGIN OPENSSH PRIVATE KEY-----\n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\nLmxvY2FsAQIDBAUG\n-----END OPENSSH PRIVATE KEY-----"

      - name: Copy files to SSH server
        run: scp -i ssh_key -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -r ./timemaster ./front docker-compose.yml root@63.250.57.169:/home/omc/projet

      - name: Restart Docker services on SSH server
        run: |
          ssh -i ssh_key -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null root@63.250.57.169 "cd /home/omc/app/projet && docker-compose down -v && docker-compose up --build -d"